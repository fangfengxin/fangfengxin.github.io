<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>








  <meta name="google-site-verification" content="N8ofSn2GrmJ51OE3RhiifNsuUcNAfC7JAukwhpY-WiY"/>












  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link rel="stylesheet" href="https://fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"/>
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"/>

<link rel="stylesheet" href="/css/main.css?v=7.2.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.png?v=7.2.0" color="#222">


  <link rel="manifest" href="/images/site.webmanifest">


  <meta name="msapplication-config" content="/images/browserconfig.xml"/>





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":true},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":"default"},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>



  <meta name="description" content="MyBatis 的连接池技术 连接池就是用于存储连接的一个容器，其实就是一个集合，该集合必须是线程安全的，不能两个线程拿到同一个连接。该集合还必须实现队列的 FIFO 特性。使用连接池技术可以减少获取连接所消耗的时间。 MyBatis 中采用自己的连接池技术。在 MyBatis 的 SqlMapConfig.xml 配置文件中，通过 &lt;dataSource type&#x3D;&quot;POOLED">
<meta property="og:type" content="article">
<meta property="og:title" content="MyBatis框架（2）">
<meta property="og:url" content="https://fangfengxin.top/2020/06/11/mybatis-2.html">
<meta property="og:site_name" content="Flexia&#39;s Blog">
<meta property="og:description" content="MyBatis 的连接池技术 连接池就是用于存储连接的一个容器，其实就是一个集合，该集合必须是线程安全的，不能两个线程拿到同一个连接。该集合还必须实现队列的 FIFO 特性。使用连接池技术可以减少获取连接所消耗的时间。 MyBatis 中采用自己的连接池技术。在 MyBatis 的 SqlMapConfig.xml 配置文件中，通过 &lt;dataSource type&#x3D;&quot;POOLED">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/mybatis%E4%B8%AD%E7%9A%843%E7%A7%8D%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%AE%9E%E7%8E%B0.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E8%B4%A6%E6%88%B7%E4%BF%A1%E6%81%AF%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7%E7%9A%84%E8%B4%A6%E6%88%B7%E4%BF%A1%E6%81%AF%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E6%9F%A5%E8%AF%A2%E8%A7%92%E8%89%B2%E5%8F%8A%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E5%A6%82%E4%BD%95%E5%BC%80%E5%90%AFmybatis%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E5%8F%AA%E6%9F%A5%E8%AF%A2%E8%B4%A6%E6%88%B7%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E5%8F%AA%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/mybatis%E7%BC%93%E5%AD%98%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E8%AF%81%E6%98%8E%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E5%AD%98%E5%9C%A8.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E6%B8%85%E7%A9%BA.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E6%B5%8B%E8%AF%95%E6%9B%B4%E6%96%B0%E5%AF%BC%E8%87%B4%E6%B8%85%E7%A9%BA%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/%E6%B5%8B%E8%AF%95%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98.png">
<meta property="article:published_time" content="2020-06-10T18:43:00.000Z">
<meta property="article:modified_time" content="2020-07-13T08:44:22.131Z">
<meta property="article:author" content="Flexia">
<meta property="article:tag" content="SSM">
<meta property="article:tag" content="MyBatis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fangfengxin.top/2020/06/11/mybatis-2/mybatis%E4%B8%AD%E7%9A%843%E7%A7%8D%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%AE%9E%E7%8E%B0.png">





  
  
  <link rel="canonical" href="https://fangfengxin.top/2020/06/11/mybatis-2"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MyBatis框架（2） | Flexia's Blog</title>
  




  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-145696891-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-145696891-1');
    }
  </script>



  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ccc4ebbe605a1363703684938a4b4c40";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Flexia's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">记录小方方的学习之路</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br/>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br/>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br/>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br/>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



</div>
    </header>

    
  
  

  

  <a href="https://github.com/fangfengxin" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fangfengxin.top/2020/06/11/mybatis-2.html"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Flexia"/>
      <meta itemprop="description" content="小方方跨到计算机，要开始学习各种计算机知识啦，加油嗷~"/>
      <meta itemprop="image" content="/images/avatar.png"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Flexia's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">MyBatis框架（2）

              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-06-11 02:43:00" itemprop="dateCreated datePublished" datetime="2020-06-11T02:43:00+08:00">2020-06-11</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-07-13 16:44:22" itemprop="dateModified" datetime="2020-07-13T16:44:22+08:00">2020-07-13</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SSM/" itemprop="url" rel="index"><span itemprop="name">SSM</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SSM/MyBatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a></span>

                
                
              
            </span>
          
		  
		  <br/>

          
            
            
              
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2020/06/11/mybatis-2.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/06/11/mybatis-2.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">31k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">28 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="MyBatis-的连接池技术"><a href="#MyBatis-的连接池技术" class="headerlink" title="MyBatis 的连接池技术"></a>MyBatis 的连接池技术</h1><ul>
<li>连接池就是用于存储连接的一个容器，其实就是一个集合，该集合必须是线程安全的，不能两个线程拿到同一个连接。该集合还必须实现队列的 FIFO 特性。使用连接池技术可以减少获取连接所消耗的时间。</li>
<li>MyBatis 中采用自己的连接池技术。在 MyBatis 的 <code>SqlMapConfig.xml</code> 配置文件中，通过 <code>&lt;dataSource type=&quot;POOLED&quot;&gt;</code> 来实现 MyBatis 中连接池的配置。</li>
</ul>
<h2 id="MyBatis-连接池的分类"><a href="#MyBatis-连接池的分类" class="headerlink" title="MyBatis 连接池的分类"></a>MyBatis 连接池的分类</h2><ul>
<li>MyBatis 提供了 3 种方式配置连接池：<ul>
<li><code>POOLED</code>：使用连接池的数据源。采用传统的 <code>javax.sql.DataSource</code> 规范中的连接池，MyBatis 中有针对的实现。</li>
<li><code>UNPOOLED</code>：不使用连接池的数据源。采用传统的获取连接的方式，虽然也实现了 <code>javax.sql.DataSource</code> 接口，但没有使用池的思想。</li>
<li><code>JNDI</code>：采用服务器提供的 JNDI 技术实现，来获取 <code>DataSource</code> 对象，不同的服务器能拿到的 <code>DataSource</code> 是不一样的。如果不是 WEB 或 Maven 的 war 工程是不能使用的。</li>
</ul>
</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/mybatis中的3种连接池实现.png" alt="mybatis中的3种连接池实现"></p>
<ul>
<li>相应地，MyBatis 内部分别定义了实现了 <code>java.sql.DataSource</code> 接口的 <code>UnpooledDataSource</code> 和 <code>PooledDataSource</code> 类来表示 <code>UNPOOLED</code>、<code>POOLED</code> 类型的数据源。</li>
<li><code>PooledDataSource</code> 持有一个 <code>UnpooledDataSource</code> 的引用，当 <code>PooledDataSource</code> 需要创建 <code>java.sql.Connection</code> 实例对象时，还是通过 <code>UnpooledDataSource</code> 来创建，<code>PooledDataSource</code> 只是提供了一种缓存连接池机制。</li>
</ul>
<h2 id="MyBatis-中-DataSource-的存取"><a href="#MyBatis-中-DataSource-的存取" class="headerlink" title="MyBatis 中 DataSource 的存取"></a>MyBatis 中 <code>DataSource</code> 的存取</h2><ul>
<li>MyBatis 是通过工厂模式来创建数据源 <code>DataSource</code> 对象的，MyBatis 定义了抽象的工厂接口 <code>DataSourceFactory</code>，通过其 <code>getDataSource()</code> 方法返回数据源 <code>DataSource</code>。<code>DataSourceFactory</code> 源码具体如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">DataSource <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyBatis 创建了 <code>DataSource</code> 实例后，会将其放到 <code>Configuration</code> 对象内的 <code>Environment</code> 对象中，供以后使用。</li>
</ul>
<h2 id="MyBatis-中连接的获取过程分析"><a href="#MyBatis-中连接的获取过程分析" class="headerlink" title="MyBatis 中连接的获取过程分析"></a>MyBatis 中连接的获取过程分析</h2><ul>
<li>当创建 <code>SqlSession</code> 对象并需要执行 SQL 语句时，MyBatis 才会去调用 <code>dataSource</code> 对象来创建 <code>java.sql.Connection</code> 对象。也就是说，<code>java.sql.Connection</code> 对象的创建一直延迟到执行 SQL 语句的时候。</li>
<li>获取连接的源码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PooledDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.popConnection(<span class="keyword">this</span>.dataSource.getUsername(), <span class="keyword">this</span>.dataSource.getPassword()).getProxyConnection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.popConnection(username, password).getProxyConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> PooledConnection <span class="title">popConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">while</span>(conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.state) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.state.idleConnections.isEmpty()) &#123;</span><br><span class="line">                    conn = (PooledConnection)<span class="keyword">this</span>.state.idleConnections.remove(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Checked out connection "</span> + conn.getRealHashCode() + <span class="string">" from pool."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state.activeConnections.size() &lt; <span class="keyword">this</span>.poolMaximumActiveConnections) &#123;</span><br><span class="line">                    conn = <span class="keyword">new</span> PooledConnection(<span class="keyword">this</span>.dataSource.getConnection(), <span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(<span class="string">"Created connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    PooledConnection oldestActiveConnection = (PooledConnection)<span class="keyword">this</span>.state.activeConnections.get(<span class="number">0</span>);</span><br><span class="line">                    ......</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>真正连接打开的时间点，只是在执行 SQL 语句时，才会进行。</li>
<li>可以进一步发现，数据库连接是最为宝贵的资源，只有在要用到的时候，才去获取并打开连接，用完了就再立即将数据库连接归还到连接池中。</li>
</ul>
<h1 id="MyBatis-的事务控制"><a href="#MyBatis-的事务控制" class="headerlink" title="MyBatis 的事务控制"></a>MyBatis 的事务控制</h1><ul>
<li>MyBatis 通过 <code>SqlSession</code> 对象的 <code>commit</code> 和 <code>rollback</code> 方法实现事务的提交和回滚。</li>
<li><strong>MyBatis 中事务的提交方式，本质上就是调用 JDBC 的 <code>setAutoCommit()</code> 来实现事务控制</strong>。</li>
<li>之前的 CUD 操作过程中，我们都要手动进行事务的提交，主要原因就是在连接池中取出的连接，都会将调用 <code>connection.setAutoCommit(false)</code> 方法，这样就必须使用 <code>sqlSession.commit()</code> 方法，相当于使用了 JDBC 中的 <code>connection.commit()</code> 方法实现事务提交。</li>
<li>可以调用 <code>factory.openSession(true)</code> 方法，设置 MyBatis 的事务自动提交。</li>
<li>就编程而言，设置为自动提交方式为 <code>false</code> 再根据情况决定是否进行提交，这种方式更常用。因为可以根据业务情况来决定提交是否进行提交。</li>
</ul>
<h1 id="MyBatis-的动态-SQL"><a href="#MyBatis-的动态-SQL" class="headerlink" title="MyBatis 的动态 SQL"></a>MyBatis 的动态 SQL</h1><ul>
<li>MyBatis 的映射文件中，前面案例中的 SQL 都是比较简单的，有些时候业务逻辑复杂时，SQL 是动态变化的，此时在前面学习中的 SQL 就不能满足要求了。</li>
</ul>
<h2 id="动态-SQL-之-lt-if-gt-标签"><a href="#动态-SQL-之-lt-if-gt-标签" class="headerlink" title="动态 SQL 之 &lt;if&gt; 标签"></a>动态 SQL 之 <code>&lt;if&gt;</code> 标签</h2><ul>
<li>根据实体类的不同取值，使用不同的 SQL 语句来进行查询。比如在 <code>id</code> 如果不为空时可以根据 <code>id</code> 查询，如果 <code>username</code> 不同空时还要加入用户名作为条件。这种情况在多条件组合查询中经常会碰到。</li>
</ul>
<h3 id="持久层-Dao-接口"><a href="#持久层-Dao-接口" class="headerlink" title="持久层 Dao 接口"></a>持久层 Dao 接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户信息查询用户列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findByUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="持久层-Dao-映射配置"><a href="#持久层-Dao-映射配置" class="headerlink" title="持久层 Dao 映射配置"></a>持久层 Dao 映射配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByUser"</span> <span class="attr">parameterType</span>=<span class="string">"User"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        select * from user where 1 = 1</span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and username != ''"</span>&gt;</span></span><br><span class="line">            and username like #&#123;username&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"address != null"</span>&gt;</span></span><br><span class="line">            and address like #&#123;address&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意事项：<ul>
<li><strong><code>&lt;if&gt;</code> 标签的 <code>test</code> 属性中写的是对象的属性名，如果是包装类对象需要使用 OGNL 表达式的写法</strong>。</li>
<li>另外需要注意 <code>where 1 = 1</code> 的作用。</li>
</ul>
</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisDataSourceAndTxTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindByUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(<span class="string">"%王%"</span>);</span><br><span class="line">        user.setAddress(<span class="string">"%金燕龙%"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; users = mapper.findByUser(user);</span><br><span class="line">        <span class="keyword">for</span> (User u : users) &#123;</span><br><span class="line">            System.out.println(u);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="动态-SQL-之-lt-where-gt-标签"><a href="#动态-SQL-之-lt-where-gt-标签" class="headerlink" title="动态 SQL 之 &lt;where&gt; 标签"></a>动态 SQL 之 <code>&lt;where&gt;</code> 标签</h2><ul>
<li>为了简化上面 <code>where 1 = 1</code> 的条件封装，可以采用 <code>&lt;where&gt;</code> 标签来简化开发。</li>
<li>修改映射配置如下：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByUser"</span> <span class="attr">parameterType</span>=<span class="string">"User"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and username != ''"</span>&gt;</span></span><br><span class="line">                and username like #&#123;username&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"address != null"</span>&gt;</span></span><br><span class="line">                and address like #&#123;address&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;where&gt;</code> 标签可以自动处理第一个 <code>and</code>。</li>
</ul>
<h2 id="动态-SQL-之-lt-foreach-gt-标签"><a href="#动态-SQL-之-lt-foreach-gt-标签" class="headerlink" title="动态 SQL 之 &lt;foreach&gt; 标签"></a>动态 SQL 之 <code>&lt;foreach&gt;</code> 标签</h2><ul>
<li>传入多个 <code>id</code> 查询用户信息，用下边两个 SQL 实现：<ul>
<li><code>SELECT * FROM USERS WHERE username LIKE &#39;%张%&#39; AND (id =10 OR id =89 OR id=16)</code></li>
<li><code>SELECT * FROM USERS WHERE username LIKE &#39;%张%&#39; AND id IN (10,89,16)</code></li>
</ul>
</li>
<li>那么在进行范围查询的时候，如何将一个集合作为参数动态传递？</li>
</ul>
<h3 id="在-QueryVo-中加入一个-List-集合用于封装参数"><a href="#在-QueryVo-中加入一个-List-集合用于封装参数" class="headerlink" title="在 QueryVo 中加入一个 List 集合用于封装参数"></a>在 <code>QueryVo</code> 中加入一个 <code>List</code> 集合用于封装参数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; ids;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">getIds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ids;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIds</span><span class="params">(List&lt;Integer&gt; ids)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ids = ids;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="持久层-Dao"><a href="#持久层-Dao" class="headerlink" title="持久层 Dao"></a>持久层 Dao</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id集合查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> vo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findInIds</span><span class="params">(QueryVo vo)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="持久层-Dao-映射配置-1"><a href="#持久层-Dao-映射配置-1" class="headerlink" title="持久层 Dao 映射配置"></a>持久层 Dao 映射配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findInIds"</span> <span class="attr">parameterType</span>=<span class="string">"QueryVo"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"ids != null and ids.size() &gt; 0"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"ids"</span> <span class="attr">open</span>=<span class="string">"and id in ("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">item</span>=<span class="string">"uid"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">                    #&#123;uid&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>SQL 语句是 <code>select * from user where id in (?)</code>。</li>
<li><code>&lt;foreach&gt;</code> 标签用于遍历集合。<ul>
<li><code>collection</code>：代表要遍历的集合元素，注意编写时不要写 <code>#{}</code>。</li>
<li><code>open</code>：代表语句的开始部分。</li>
<li><code>close</code>：代表结束部分。</li>
<li><code>item</code>：代表遍历集合的每个元素，生成的变量名。</li>
<li><code>separator</code>：代表分隔符。</li>
</ul>
</li>
</ul>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisDataSourceAndTxTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindInIds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryVo vo = <span class="keyword">new</span> QueryVo();</span><br><span class="line">        vo.setIds(List.of(<span class="number">41</span>, <span class="number">42</span>, <span class="number">43</span>, <span class="number">46</span>, <span class="number">57</span>));</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; users = mapper.findInIds(vo);</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="MyBatis-中简化编写的-SQL-片段"><a href="#MyBatis-中简化编写的-SQL-片段" class="headerlink" title="MyBatis 中简化编写的 SQL 片段"></a>MyBatis 中简化编写的 SQL 片段</h2><h3 id="定义代码片段"><a href="#定义代码片段" class="headerlink" title="定义代码片段"></a>定义代码片段</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义代码片段 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"defaultSql"</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="引用代码片段"><a href="#引用代码片段" class="headerlink" title="引用代码片段"></a>引用代码片段</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByUser"</span> <span class="attr">parameterType</span>=<span class="string">"User"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"defaultSql"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and username != ''"</span>&gt;</span></span><br><span class="line">                and username like #&#123;username&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"address != null"</span>&gt;</span></span><br><span class="line">                and address like #&#123;address&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="MyBatis-的多表关联查询"><a href="#MyBatis-的多表关联查询" class="headerlink" title="MyBatis 的多表关联查询"></a>MyBatis 的多表关联查询</h1><h2 id="MyBatis-多表查询之一对一（多对一）"><a href="#MyBatis-多表查询之一对一（多对一）" class="headerlink" title="MyBatis 多表查询之一对一（多对一）"></a>MyBatis 多表查询之一对一（多对一）</h2><ul>
<li>MyBatis 中将多对一关系看成一对一关系进行处理。因为多对一关系中，多的一方任意一个都只能对应一个一的一方。</li>
<li>现有数据库，一个用户可以拥有多个账户，但是每个账户只能对应一个用户。</li>
<li>实现查询账户信息时，也要查询账户所对应的用户信息。</li>
</ul>
<h3 id="方式一：创建输出类型"><a href="#方式一：创建输出类型" class="headerlink" title="方式一：创建输出类型"></a>方式一：创建输出类型</h3><ul>
<li>定义专门的 pojo 类作为输出类型，其中定义了 SQL 查询结果集所有的字段。此方法较为简单，企业中使用普遍。</li>
</ul>
<h4 id="定义账户信息实体类"><a href="#定义账户信息实体类" class="headerlink" title="定义账户信息实体类"></a>定义账户信息实体类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="编写-SQL-语句"><a href="#编写-SQL-语句" class="headerlink" title="编写 SQL 语句"></a>编写 SQL 语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> account.*,</span><br><span class="line">       user.username,</span><br><span class="line">       user.address</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">account</span>,</span><br><span class="line">     <span class="keyword">user</span></span><br><span class="line"><span class="keyword">where</span> account.uid = user.id</span><br></pre></td></tr></table></figure>
<ul>
<li>数据库查询结果如下：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/查询所有账户信息结果.png" alt></p>
<h4 id="定义-AccountUser-类"><a href="#定义-AccountUser-类" class="headerlink" title="定义 AccountUser 类"></a>定义 <code>AccountUser</code> 类</h4><ul>
<li>为了能够封装上面 SQL 语句的查询结果，定义 <code>AccountUser</code> 类中要包含账户信息同时还要包含用户信息，所以我们要在定义 <code>AccountUser</code> 类时可以继承 <code>Account</code> 类。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountUser</span> <span class="keyword">extends</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.toString() + <span class="string">"  AccountUser&#123;"</span> +</span><br><span class="line">                <span class="string">"username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", address='"</span> + address + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="定义账户的持久层-Dao-接口"><a href="#定义账户的持久层-Dao-接口" class="headerlink" title="定义账户的持久层 Dao 接口"></a>定义账户的持久层 Dao 接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有账户，同时包含用户姓名和地址信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;AccountUser&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="定义-AccountUser-xml-映射配置信息"><a href="#定义-AccountUser-xml-映射配置信息" class="headerlink" title="定义 AccountUser.xml 映射配置信息"></a>定义 <code>AccountUser.xml</code> 映射配置信息</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.AccountDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultType</span>=<span class="string">"AccountUser"</span>&gt;</span></span><br><span class="line">        select a.*, u.username, u.address</span><br><span class="line">        from account a, user u</span><br><span class="line">        where u.id = a.uid</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意：因为上面查询的结果中包含了账户信息同时还包含了用户信息，所以返回值类型 <code>returnType</code> 的值设置为 <code>AccountUser</code> 类型，这样就可以接收账户信息和用户信息了。</li>
</ul>
<h4 id="创建测试类"><a href="#创建测试类" class="headerlink" title="创建测试类"></a>创建测试类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InputStream config;</span><br><span class="line">    <span class="keyword">private</span> SqlSession session;</span><br><span class="line">    <span class="keyword">private</span> AccountDao mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        config = Resources.getResourceAsStream(<span class="string">"SqlMapConfig.xml"</span>);</span><br><span class="line">        SqlSessionFactoryBuilder builder = <span class="keyword">new</span> SqlSessionFactoryBuilder();</span><br><span class="line">        SqlSessionFactory factory = builder.build(config);</span><br><span class="line">        session = factory.openSession();</span><br><span class="line">        mapper = session.getMapper(AccountDao.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 在关闭资源之前，提交事务</span></span><br><span class="line">        session.commit();</span><br><span class="line"></span><br><span class="line">        session.close();</span><br><span class="line">        config.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;AccountUser&gt; accounts = mapper.findAll();</span><br><span class="line">        <span class="keyword">for</span> (AccountUser account : accounts) &#123;</span><br><span class="line">            System.out.println(account);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Account&#123;id=<span class="number">1</span>, uid=<span class="number">41</span>, money=<span class="number">1000.0</span>&#125;  AccountUser&#123;username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>&#125;</span><br><span class="line">Account&#123;id=<span class="number">2</span>, uid=<span class="number">45</span>, money=<span class="number">1000.0</span>&#125;  AccountUser&#123;username=<span class="string">'传智播客'</span>, address=<span class="string">'北京金燕龙'</span>&#125;</span><br><span class="line">Account&#123;id=<span class="number">3</span>, uid=<span class="number">41</span>, money=<span class="number">2000.0</span>&#125;  AccountUser&#123;username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="方式二：使用组合"><a href="#方式二：使用组合" class="headerlink" title="方式二：使用组合"></a>方式二：使用组合</h3><ul>
<li>通过面向对象的 <code>Has-A</code> 关系得知，可以在 <code>Account</code> 类中加入一个 <code>User</code> 类的对象来代表这个账户是哪个用户的。</li>
<li>使用 <code>resultMap</code>，定义专门的 <code>resultMap</code> 用于映射一对一查询结果。</li>
</ul>
<h4 id="修改-Account-类"><a href="#修改-Account-类" class="headerlink" title="修改 Account 类"></a>修改 <code>Account</code> 类</h4><ul>
<li>在 <code>Account</code> 类中加入 <code>User</code> 类的对象作为 <code>Account</code> 类的一个属性。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="修改-AccountDao-接口中的方法"><a href="#修改-AccountDao-接口中的方法" class="headerlink" title="修改 AccountDao 接口中的方法"></a>修改 <code>AccountDao</code> 接口中的方法</h4><ul>
<li>将返回值改回 <code>Account</code> 类型。</li>
<li>因为 <code>Account</code> 类中包含了一个 User 类的对象，它可以封装账户所对应的用户信息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有账户，同时包含用户姓名和地址信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="重新定义-AccountDao-xml-文件"><a href="#重新定义-AccountDao-xml-文件" class="headerlink" title="重新定义 AccountDao.xml 文件"></a>重新定义 <code>AccountDao.xml</code> 文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.AccountDao"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 建立account和user的对应关系 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"accountUserMap"</span> <span class="attr">type</span>=<span class="string">"Account"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"aid"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"uid"</span> <span class="attr">column</span>=<span class="string">"uid"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"money"</span> <span class="attr">column</span>=<span class="string">"money"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 用于指定从表方的引用实体属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"user"</span> <span class="attr">column</span>=<span class="string">"uid"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address"</span> <span class="attr">column</span>=<span class="string">"address"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"birthday"</span> <span class="attr">column</span>=<span class="string">"birthday"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultMap</span>=<span class="string">"accountUserMap"</span>&gt;</span></span><br><span class="line">        select u.*, a.id as aid, a.uid, a.money</span><br><span class="line">        from account a, user u</span><br><span class="line">        where a.uid = u.id</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; accounts = mapper.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Account account : accounts) &#123;</span><br><span class="line">            System.out.println(account + <span class="string">"  "</span> + account.getUser());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Account&#123;id=<span class="number">1</span>, uid=<span class="number">41</span>, money=<span class="number">1000.0</span>&#125;  User&#123;id=<span class="number">41</span>, username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>, sex=<span class="string">'男'</span>, birthday=Tue Feb <span class="number">27</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">08</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">Account&#123;id=<span class="number">2</span>, uid=<span class="number">45</span>, money=<span class="number">1000.0</span>&#125;  User&#123;id=<span class="number">45</span>, username=<span class="string">'传智播客'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'男'</span>, birthday=Sun Mar <span class="number">04</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">06</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">Account&#123;id=<span class="number">3</span>, uid=<span class="number">41</span>, money=<span class="number">2000.0</span>&#125;  User&#123;id=<span class="number">41</span>, username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>, sex=<span class="string">'男'</span>, birthday=Tue Feb <span class="number">27</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">08</span> CST <span class="number">2018</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="MyBatis-多表查询之一对多"><a href="#MyBatis-多表查询之一对多" class="headerlink" title="MyBatis 多表查询之一对多"></a>MyBatis 多表查询之一对多</h2><ul>
<li>查询所有用户信息及用户关联的账户信息。</li>
</ul>
<h3 id="编写-SQL-语句-1"><a href="#编写-SQL-语句-1" class="headerlink" title="编写 SQL 语句"></a>编写 SQL 语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">user</span> u <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> <span class="keyword">account</span> a</span><br><span class="line"><span class="keyword">on</span> u.id = a.uid</span><br></pre></td></tr></table></figure>
<ul>
<li>数据库查询结果：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/查询所有用户的账户信息结果.png" alt></p>
<h3 id="User-类中加入-List-lt-Account-gt"><a href="#User-类中加入-List-lt-Account-gt" class="headerlink" title="User 类中加入 List&lt;Account&gt;"></a><code>User</code> 类中加入 <code>List&lt;Account&gt;</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Account&gt; accounts;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修改映射配置文件"><a href="#修改映射配置文件" class="headerlink" title="修改映射配置文件"></a>修改映射配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userAccountMap"</span> <span class="attr">type</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address"</span> <span class="attr">column</span>=<span class="string">"address"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"birthday"</span> <span class="attr">column</span>=<span class="string">"birthday"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置user对象中accounts集合的映射 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"accounts"</span> <span class="attr">ofType</span>=<span class="string">"Account"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"aid"</span> <span class="attr">property</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"uid"</span> <span class="attr">property</span>=<span class="string">"uid"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"money"</span> <span class="attr">property</span>=<span class="string">"money"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultMap</span>=<span class="string">"userAccountMap"</span>&gt;</span></span><br><span class="line">        select * from user u left outer join account a on u.id = a.uid</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>collection</code> 表示关联查询结果集</strong>。<ul>
<li><code>property</code>：指定关联查询结果集存储在哪个属性中。</li>
<li><code>ofType</code>：指定关联查询结果集中的对象类型。可以使用别名，也可以使用全限定名。</li>
</ul>
</li>
</ul>
<h3 id="测试结果-1"><a href="#测试结果-1" class="headerlink" title="测试结果"></a>测试结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = mapper.findAll();</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">            System.out.println(user.getAccounts());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">User&#123;id=<span class="number">41</span>, username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>, sex=<span class="string">'男'</span>, birthday=Tue Feb <span class="number">27</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">08</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[Account&#123;id=<span class="keyword">null</span>, uid=<span class="number">41</span>, money=<span class="number">1000.0</span>&#125;, Account&#123;id=<span class="keyword">null</span>, uid=<span class="number">41</span>, money=<span class="number">2000.0</span>&#125;]</span><br><span class="line">User&#123;id=<span class="number">45</span>, username=<span class="string">'传智播客'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'男'</span>, birthday=Sun Mar <span class="number">04</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">06</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[Account&#123;id=<span class="keyword">null</span>, uid=<span class="number">45</span>, money=<span class="number">1000.0</span>&#125;]</span><br><span class="line">User&#123;id=<span class="number">42</span>, username=<span class="string">'小二王'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'女'</span>, birthday=Fri Mar <span class="number">02</span> <span class="number">15</span>:<span class="number">09</span>:<span class="number">37</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br><span class="line">User&#123;id=<span class="number">43</span>, username=<span class="string">'小二王'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'女'</span>, birthday=Sun Mar <span class="number">04</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">34</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br><span class="line">User&#123;id=<span class="number">46</span>, username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>, sex=<span class="string">'男'</span>, birthday=Wed Mar <span class="number">07</span> <span class="number">17</span>:<span class="number">37</span>:<span class="number">26</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br><span class="line">User&#123;id=<span class="number">48</span>, username=<span class="string">'小马宝莉'</span>, address=<span class="string">'北京修正'</span>, sex=<span class="string">'女'</span>, birthday=Thu Mar <span class="number">08</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">00</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>
<h2 id="MyBatis-多表查询之多对多"><a href="#MyBatis-多表查询之多对多" class="headerlink" title="MyBatis 多表查询之多对多"></a>MyBatis 多表查询之多对多</h2><ul>
<li>上面使用 MyBatis 实现了一对多关系的维护。</li>
<li><strong>多对多关系其实就是双向的一对多关系</strong>。</li>
</ul>
<h3 id="业务要求及-SQL"><a href="#业务要求及-SQL" class="headerlink" title="业务要求及 SQL"></a>业务要求及 SQL</h3><ul>
<li>使用用户与角色的关系模型进行实现。</li>
<li>查询所有角色并且加载它所分配的用户信息。</li>
<li>查询角色我们需要用到 <code>Role</code> 表，但角色分配的用户的信息我们并不能直接找到用户信息，而是要通过中间表（<code>USER_ROLE</code> 表）才能关联到用户信息。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> r.id <span class="keyword">as</span> rid, role_name, role_desc, u.* <span class="keyword">from</span> <span class="keyword">role</span> r</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> user_role ur <span class="keyword">on</span> r.id = ur.rid</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> <span class="keyword">user</span> u <span class="keyword">on</span> ur.uid = u.id</span><br></pre></td></tr></table></figure>
<ul>
<li>数据库查询结果：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/查询角色及用户信息.png" alt></p>
<h3 id="编写角色实体类-Role"><a href="#编写角色实体类-Role" class="headerlink" title="编写角色实体类 Role"></a>编写角色实体类 <code>Role</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">    <span class="keyword">private</span> String roleDesc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多对多的关系映射：一个角色可以赋予多个用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; users;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写-Role-的持久层接口"><a href="#编写-Role-的持久层接口" class="headerlink" title="编写 Role 的持久层接口"></a>编写 <code>Role</code> 的持久层接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有角色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Role&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写映射配置文件"><a href="#编写映射配置文件" class="headerlink" title="编写映射配置文件"></a>编写映射配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userAccountMap"</span> <span class="attr">type</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address"</span> <span class="attr">column</span>=<span class="string">"address"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"birthday"</span> <span class="attr">column</span>=<span class="string">"birthday"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"roles"</span> <span class="attr">ofType</span>=<span class="string">"Role"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"rid"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleDesc"</span> <span class="attr">column</span>=<span class="string">"role_desc"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultMap</span>=<span class="string">"userAccountMap"</span>&gt;</span></span><br><span class="line">        select u.*, r.id as rid, role_name, role_desc from user u</span><br><span class="line">        left outer join user_role ur on u.id = ur.uid</span><br><span class="line">        left outer join role r on ur.rid = r.id</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-2"><a href="#测试结果-2" class="headerlink" title="测试结果"></a>测试结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Role&gt; roles = mapper.findAll();</span><br><span class="line">        <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">            System.out.println(role);</span><br><span class="line">            System.out.println(role.getUsers());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">User&#123;id=<span class="number">41</span>, username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>, sex=<span class="string">'男'</span>, birthday=Tue Feb <span class="number">27</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">08</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[Role&#123;id=<span class="number">1</span>, roleName=<span class="string">'院长'</span>, roleDesc=<span class="string">'管理整个学院'</span>&#125;, Role&#123;id=<span class="number">2</span>, roleName=<span class="string">'总裁'</span>, roleDesc=<span class="string">'管理整个公司'</span>&#125;]</span><br><span class="line">User&#123;id=<span class="number">45</span>, username=<span class="string">'传智播客'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'男'</span>, birthday=Sun Mar <span class="number">04</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">06</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[Role&#123;id=<span class="number">1</span>, roleName=<span class="string">'院长'</span>, roleDesc=<span class="string">'管理整个学院'</span>&#125;]</span><br><span class="line">User&#123;id=<span class="number">42</span>, username=<span class="string">'小二王'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'女'</span>, birthday=Fri Mar <span class="number">02</span> <span class="number">15</span>:<span class="number">09</span>:<span class="number">37</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br><span class="line">User&#123;id=<span class="number">43</span>, username=<span class="string">'小二王'</span>, address=<span class="string">'北京金燕龙'</span>, sex=<span class="string">'女'</span>, birthday=Sun Mar <span class="number">04</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">34</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br><span class="line">User&#123;id=<span class="number">46</span>, username=<span class="string">'老王'</span>, address=<span class="string">'北京'</span>, sex=<span class="string">'男'</span>, birthday=Wed Mar <span class="number">07</span> <span class="number">17</span>:<span class="number">37</span>:<span class="number">26</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br><span class="line">User&#123;id=<span class="number">48</span>, username=<span class="string">'小马宝莉'</span>, address=<span class="string">'北京修正'</span>, sex=<span class="string">'女'</span>, birthday=Thu Mar <span class="number">08</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">00</span> CST <span class="number">2018</span>&#125;</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>
<h1 id="MyBatis-延迟加载策略"><a href="#MyBatis-延迟加载策略" class="headerlink" title="MyBatis 延迟加载策略"></a>MyBatis 延迟加载策略</h1><ul>
<li>通过前面的学习，我们已经掌握了 MyBatis 中一对一、一对多、多对多关系的配置及实现，可以实现对象的关联查询。</li>
<li>实际开发过程中很多时候我们并不需要总是在加载用户信息时就一定要加载他的账户信息。此时就是我们所说的延迟加载。</li>
</ul>
<h2 id="何为延迟加载"><a href="#何为延迟加载" class="headerlink" title="何为延迟加载"></a>何为延迟加载</h2><ul>
<li>问题：在一对多中，有一个用户，它有 100 个账户。<ul>
<li>在查询用户时，要不要把关联的账户查询出来？</li>
<li>在查询账户时，要不要把关联的用户查询出来？</li>
</ul>
</li>
<li>解决：<ul>
<li>在查询用户时，用户下的账户信息应该是，什么时候用，什么时候查询。</li>
<li>在查询账户时，账户的所属用户信息应该，随着账户查询一起查询出来。</li>
</ul>
</li>
<li><strong>延迟加载：</strong><ul>
<li><strong>在需要用到数据时才进行加载，不需要用到数据时就不加载数据</strong>。</li>
<li>延迟加载也称按需加载、懒加载。</li>
</ul>
</li>
<li>立即加载：<ul>
<li>不管需不需要使用数据，只要一调用方法就马上发起查询。</li>
</ul>
</li>
<li>使用时机：<ul>
<li>一对多和多对多关系中，通常采用延迟加载。</li>
<li>多对一和一对一关系中，通常采用立即加载。</li>
</ul>
</li>
</ul>
<h2 id="实现延迟加载"><a href="#实现延迟加载" class="headerlink" title="实现延迟加载"></a>实现延迟加载</h2><ul>
<li>我们使用了 <code>resultMap</code> 来实现一对一，一对多，多对多关系的操作。主要是通过 <code>association</code>、<code>collection</code> 实现一对一及一对多映射。<code>association</code>、<code>collection</code> 具备延迟加载功能。</li>
</ul>
<h3 id="使用-association-实现延迟加载"><a href="#使用-association-实现延迟加载" class="headerlink" title="使用 association 实现延迟加载"></a>使用 <code>association</code> 实现延迟加载</h3><ul>
<li>在多对一关系配置的 <code>&lt;association&gt;</code> 结点中配置延迟加载策略。</li>
</ul>
<h4 id="账户的持久层接口"><a href="#账户的持久层接口" class="headerlink" title="账户的持久层接口"></a>账户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有账户，同时包含用户姓名和地址信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="账户的持久层映射配置"><a href="#账户的持久层映射配置" class="headerlink" title="账户的持久层映射配置"></a>账户的持久层映射配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.AccountDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"accountMap"</span> <span class="attr">type</span>=<span class="string">"Account"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"uid"</span> <span class="attr">column</span>=<span class="string">"uid"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"money"</span> <span class="attr">column</span>=<span class="string">"money"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 一对一的关系映射：配置封装user的内容，</span></span><br><span class="line"><span class="comment">             select属性指定的内容：查询用户的唯一标识，</span></span><br><span class="line"><span class="comment">             column属性指定的内容：用户根据id查询时，所需要的参数的值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"user"</span> <span class="attr">column</span>=<span class="string">"uid"</span> <span class="attr">select</span>=<span class="string">"dao.UserDao.findById"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultMap</span>=<span class="string">"accountMap"</span>&gt;</span></span><br><span class="line">        select * from account</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>select</code>：填写要调用的 <code>select</code> 映射的 <code>id</code></strong>。</li>
<li><strong><code>column</code>：填写要传递给 <code>select</code> 映射的参数</strong>。</li>
</ul>
<h4 id="用户的持久层接口"><a href="#用户的持久层接口" class="headerlink" title="用户的持久层接口"></a>用户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据Id查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用户的持久层映射配置"><a href="#用户的持久层映射配置" class="headerlink" title="用户的持久层映射配置"></a>用户的持久层映射配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        select * from user where id = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="开启-MyBatis-的延迟加载"><a href="#开启-MyBatis-的延迟加载" class="headerlink" title="开启 MyBatis 的延迟加载"></a>开启 MyBatis 的延迟加载</h4><ul>
<li>进入 MyBatis 的官方文档，找到 settings 的说明信息：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/如何开启mybatis延迟加载.png" alt></p>
<ul>
<li>需要在 MyBatis 的配置文件 <code>SqlMapConfig.xml</code> 中添加延迟加载的配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 开启MyBatis的延迟加载开关 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 将积极加载改为消极加载即按需加载 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"aggressiveLazyLoading"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="编写测试只查询账户信息不查用户信息"><a href="#编写测试只查询账户信息不查用户信息" class="headerlink" title="编写测试只查询账户信息不查用户信息"></a>编写测试只查询账户信息不查用户信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; accounts = mapper.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>测试结果：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/只查询账户信息.png" alt></p>
<ul>
<li>因为本次只是将 <code>Account</code> 对象查询出来放入 <code>List</code> 集合中，并没有涉及到 <code>User</code> 对象，所以就没有发出 SQL 语句查询账户所关联的 <code>User</code> 对象。</li>
</ul>
<h3 id="使用-collection-实现延迟加载"><a href="#使用-collection-实现延迟加载" class="headerlink" title="使用 collection 实现延迟加载"></a>使用 <code>collection</code> 实现延迟加载</h3><ul>
<li>可以在一对多关系配置的 <code>&lt;collection&gt;</code> 结点中配置延迟加载策略。</li>
<li><code>&lt;collection&gt;</code> 结点中也有 <code>select</code> 属性和 <code>column</code> 属性。</li>
</ul>
<h4 id="用户的持久层接口-1"><a href="#用户的持久层接口-1" class="headerlink" title="用户的持久层接口"></a>用户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用户的持久层映射配置-1"><a href="#用户的持久层映射配置-1" class="headerlink" title="用户的持久层映射配置"></a>用户的持久层映射配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userMap"</span> <span class="attr">type</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"address"</span> <span class="attr">column</span>=<span class="string">"address"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"birthday"</span> <span class="attr">column</span>=<span class="string">"birthday"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- collection 是用于建立一对多中集合属性的对应关系</span></span><br><span class="line"><span class="comment">             ofType 用于指定集合元素的数据类型</span></span><br><span class="line"><span class="comment">             select 是用于指定查询账户的唯一标识（账户的 dao 全限定类名加上方法名称）</span></span><br><span class="line"><span class="comment">             column 是用于指定使用哪个字段的值作为条件查询 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"accounts"</span> <span class="attr">ofType</span>=<span class="string">"Account"</span> <span class="attr">select</span>=<span class="string">"dao.AccountDao.findByUid"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findAll"</span> <span class="attr">resultMap</span>=<span class="string">"userMap"</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;collection&gt;</code> 标签：主要用于加载关联的集合对象。</li>
<li><strong><code>select</code> 属性</strong>：用于指定查询 <code>account</code> 列表的 SQL 语句，所以填写的是该 <strong>SQL 映射的 <code>id</code></strong>。</li>
<li><strong><code>column</code> 属性</strong>：用于指定 <code>select</code> 属性的 <strong>SQL 语句的参数来源</strong>，上面的参数来自于 <code>user</code> 的 <code>id</code> 列，所以就写成 <code>id</code> 这一个字段名了。</li>
</ul>
<h4 id="账户的持久层接口-1"><a href="#账户的持久层接口-1" class="headerlink" title="账户的持久层接口"></a>账户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户id查询账户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUid</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="账户的持久层映射配置-1"><a href="#账户的持久层映射配置-1" class="headerlink" title="账户的持久层映射配置"></a>账户的持久层映射配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.AccountDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByUid"</span> <span class="attr">resultType</span>=<span class="string">"Account"</span>&gt;</span></span><br><span class="line">        select * from account where uid = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="测试只加载用户信息"><a href="#测试只加载用户信息" class="headerlink" title="测试只加载用户信息"></a>测试只加载用户信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = mapper.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>测试结果：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/只查询用户信息.png" alt></p>
<ul>
<li>没有加载 <code>Account</code> 账户信息。</li>
</ul>
<h1 id="MyBatis-缓存"><a href="#MyBatis-缓存" class="headerlink" title="MyBatis 缓存"></a>MyBatis 缓存</h1><h2 id="简单认识缓存"><a href="#简单认识缓存" class="headerlink" title="简单认识缓存"></a>简单认识缓存</h2><ul>
<li>什么是缓存？<ul>
<li>存在于内存中的临时数据。</li>
</ul>
</li>
<li>为什么使用缓存？<ul>
<li>减少和数据库的交互次数，提高执行效率。</li>
</ul>
</li>
<li>适用场景：<ul>
<li>经常查询并且不经常改变。</li>
<li>数据的正确与否对最终结果影响不大。</li>
<li>比如：商品的库存、银行的汇率、股市的牌价。</li>
</ul>
</li>
</ul>
<h2 id="MyBatis-中的一级缓存"><a href="#MyBatis-中的一级缓存" class="headerlink" title="MyBatis 中的一级缓存"></a>MyBatis 中的一级缓存</h2><ul>
<li>MyBatis 中缓存分为一级缓存、二级缓存。</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/mybatis缓存结构.png" alt></p>
<ul>
<li><strong>MyBatis 的一级缓存是指 <code>SqlSession</code> 级别的缓存，只要 <code>SqlSession</code> 没有 <code>flush</code> 或 <code>close</code>，缓存就存在</strong>。</li>
<li>当执行查询之后，查询的结果会存入到 <code>SqlSession</code> 提供的一块区域中，<strong>该区域的结构是一个 <code>Map</code></strong>。</li>
<li>当再次查询同样的数据，MyBatis 会先去 <code>SqlSession</code> 中查询是否有结果数据，有的话直接取出使用。</li>
<li>当 <code>SqlSession</code> 对象消失时，MyBatis 的一级缓存也就消失了。</li>
</ul>
<h3 id="证明一级缓存的存在"><a href="#证明一级缓存的存在" class="headerlink" title="证明一级缓存的存在"></a>证明一级缓存的存在</h3><ul>
<li>编写用户的持久层接口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据Id查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>编写用户的持久层映射配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        select * from user where id = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>编写测试方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFirstLevelCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user1 = mapper.findById(<span class="number">41</span>);</span><br><span class="line">        <span class="comment">// session.clearCache();</span></span><br><span class="line">        User user2 = mapper.findById(<span class="number">41</span>);</span><br><span class="line">        System.out.println(user1 == user2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>测试结果 <code>true</code>：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/证明一级缓存的存在.png" alt></p>
<ul>
<li>虽然在上面的代码中查询了两次，但最后只执行了一次数据库操作，这就是 MyBatis 提供的一级缓存在起作用了。</li>
<li>因为一级缓存的存在，导致第二次查询 <code>id</code> 为 41 的记录时，并没有发出 SQL 语句从数据库中查询数据，而是从一级缓存中查询。</li>
</ul>
<h3 id="触发一级缓存的清空"><a href="#触发一级缓存的清空" class="headerlink" title="触发一级缓存的清空"></a>触发一级缓存的清空</h3><ul>
<li>一级缓存是 <code>SqlSession</code> 范围的缓存，<strong>当调用 <code>SqlSession</code> 的修改、添加、删除、<code>commit()</code>、<code>close()</code> 等方法时，就会清空一级缓存</strong>。</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/一级缓存的清空.png" alt></p>
<ul>
<li><code>SqlSession</code> 执行 CUD 操作后，清空 <code>SqlSession</code> 中的一级缓存，这样做的目的是<strong>让缓存中存储的是最新的信息，避免脏读</strong>。</li>
<li>下面测试清空一级缓存的触发。在 <code>UserDao</code> 中加入更新方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>UserDao.xml</code> 中添加更新方法的映射：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">        update user set username = #&#123;username&#125;, address = #&#123;address&#125; where id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>添加测试方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClearCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user1 = mapper.findById(<span class="number">57</span>);</span><br><span class="line">        System.out.println(user1);</span><br><span class="line"></span><br><span class="line">        user1.setUsername(<span class="string">"update user clear cache"</span>);</span><br><span class="line">        user1.setAddress(<span class="string">"北京市海淀区"</span>);</span><br><span class="line">        mapper.updateUser(user1);</span><br><span class="line"></span><br><span class="line">        User user2 = mapper.findById(<span class="number">57</span>);</span><br><span class="line">        System.out.println(user2);</span><br><span class="line"></span><br><span class="line">        System.out.println(user1 == user2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果 <code>false</code>：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/测试更新导致清空一级缓存.png" alt></p>
<ul>
<li>当执行 <code>mapper.updateUser()</code> 后，再次查询 <code>id = 57</code> 的 <code>User</code> 对象时，又重新执行了 SQL 语句，从数据库进行了查询操作。</li>
</ul>
<h2 id="MyBatis-的二级缓存"><a href="#MyBatis-的二级缓存" class="headerlink" title="MyBatis 的二级缓存"></a>MyBatis 的二级缓存</h2><ul>
<li><strong>二级缓存是 <code>Mapper</code> 映射级别的缓存</strong>，多个 <code>SqlSession</code> 去操作同一个 <code>Mapper</code> 映射的 SQL 语句，多个 <code>SqlSession</code> 可以共用二级缓存，<strong>二级缓存是跨 <code>SqlSession</code> 的</strong>。</li>
</ul>
<h3 id="二级缓存结构图"><a href="#二级缓存结构图" class="headerlink" title="二级缓存结构图"></a>二级缓存结构图</h3><p><img src="/2020/06/11/mybatis-2/二级缓存结构.png" alt></p>
<ul>
<li>首先开启 MyBatis 的二级缓存。</li>
<li><code>sqlSession1</code> 去查询用户信息，查询到用户信息会将查询数据存储到二级缓存中。</li>
<li>如果 <code>sqlSession3</code> 去执行相同 <code>mapper</code> 映射下的 SQL，执行 <code>commit</code> 提交，将会清空该 <code>mapper</code> 映射下的二级缓存区域的数据。</li>
<li><code>sqlSession2</code> 去查询与 <code>sqlSession1</code> 相同的用户信息，首先会去缓存中找是否存在数据，如果存在直接从缓存中取出数据。</li>
</ul>
<h3 id="二级缓存的开启"><a href="#二级缓存的开启" class="headerlink" title="二级缓存的开启"></a>二级缓存的开启</h3><h4 id="在-SQLMapConfig-xml-文件中开启二级缓存"><a href="#在-SQLMapConfig-xml-文件中开启二级缓存" class="headerlink" title="在 SQLMapConfig.xml 文件中开启二级缓存"></a>在 <code>SQLMapConfig.xml</code> 文件中开启二级缓存</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 开启二级缓存的支持 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>因为 <code>cacheEnabled</code> 的取值默认就为 <code>true</code>，所以这一步可以省略不配置。</li>
</ul>
<h4 id="配置相关的-Mapper-映射文件"><a href="#配置相关的-Mapper-映射文件" class="headerlink" title="配置相关的 Mapper 映射文件"></a>配置相关的 <code>Mapper</code> 映射文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 开启二级缓存的支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>&lt;cache&gt;</code> 标签表示当前这个 <code>Mapper</code> 映射将使用二级缓存，区分的标准就看 <code>Mapper</code> 的 <code>namespace</code> 值</strong>。</li>
</ul>
<h4 id="配置-statement-上的-useCache-属性"><a href="#配置-statement-上的-useCache-属性" class="headerlink" title="配置 statement 上的 useCache 属性"></a>配置 statement 上的 <code>useCache</code> 属性</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"dao.UserDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultType</span>=<span class="string">"User"</span> <span class="attr">useCache</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        select * from user where id = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="二级缓存测试"><a href="#二级缓存测试" class="headerlink" title="二级缓存测试"></a>二级缓存测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondLevelCacheTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InputStream config;</span><br><span class="line">    <span class="keyword">private</span> SqlSessionFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        config = Resources.getResourceAsStream(<span class="string">"SqlMapConfig.xml"</span>);</span><br><span class="line">        factory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        config.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSecondLevelCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSession sqlSession1 = factory.openSession();</span><br><span class="line">        UserDao mapper1 = sqlSession1.getMapper(UserDao.class);</span><br><span class="line">        User user1 = mapper1.findById(<span class="number">41</span>);</span><br><span class="line">        System.out.println(user1);</span><br><span class="line">        sqlSession1.close(); <span class="comment">// 一级缓存消失</span></span><br><span class="line"></span><br><span class="line">        SqlSession sqlSession2 = factory.openSession();</span><br><span class="line">        UserDao mapper2 = sqlSession2.getMapper(UserDao.class);</span><br><span class="line">        User user2 = mapper2.findById(<span class="number">41</span>);</span><br><span class="line">        System.out.println(user2);</span><br><span class="line">        sqlSession2.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(user1 == user2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果 <code>false</code>：</li>
</ul>
<p><img src="/2020/06/11/mybatis-2/测试二级缓存.png" alt></p>
<ul>
<li>经过上面的测试，发现执行了两次查询，并且在执行第一次查询后，关闭了一级缓存，再去执行第二次查询时，发现并没有对数据库发出 SQL 语句，所以此时的数据就只能是来自于二级缓存。</li>
<li>但是两次获得的 User 对象不是同一个，说明<strong>二级缓存中存放的是数据，而不是对象</strong>。</li>
</ul>
<h3 id="二级缓存注意事项"><a href="#二级缓存注意事项" class="headerlink" title="二级缓存注意事项"></a>二级缓存注意事项</h3><ul>
<li><strong>当使用二级缓存时，所缓存的类一定要实现 <code>java.io.Serializable</code> 接口，这样就可以使用序列化方式来保存对象的数据，同时可以使用数据反序列化对象</strong>。</li>
</ul>
<h1 id="MyBatis-注解开发"><a href="#MyBatis-注解开发" class="headerlink" title="MyBatis 注解开发"></a>MyBatis 注解开发</h1><ul>
<li>MyBatis 也可以使用注解开发方式，这样就可以减少编写 <code>Mapper</code> 映射文件。</li>
</ul>
<h2 id="MyBatis-的常见注解说明"><a href="#MyBatis-的常见注解说明" class="headerlink" title="MyBatis 的常见注解说明"></a>MyBatis 的常见注解说明</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert</span>: 实现新增</span><br><span class="line"><span class="meta">@Update</span>: 实现更新</span><br><span class="line"><span class="meta">@Delete</span>: 实现删除</span><br><span class="line"><span class="meta">@Select</span>: 实现查询</span><br><span class="line"><span class="meta">@Result</span>: 实现结果集封装</span><br><span class="line"><span class="meta">@Results</span>: 可以与<span class="meta">@Result</span>一起使用，封装多个结果集</span><br><span class="line"><span class="meta">@ResultMap</span>: 实现引用<span class="meta">@Results</span>定义的封装</span><br><span class="line"><span class="meta">@One</span>: 实现一对一结果集封装</span><br><span class="line"><span class="meta">@Many</span>: 实现一对多结果集封装</span><br><span class="line"><span class="meta">@SelectProvider</span>: 实现动态SQL映射</span><br><span class="line"><span class="meta">@CacheNamespace</span>: 实现注解二级缓存的使用</span><br></pre></td></tr></table></figure>
<h2 id="使用-MyBatis-注解实现基本-CRUD"><a href="#使用-MyBatis-注解实现基本-CRUD" class="headerlink" title="使用 MyBatis 注解实现基本 CRUD"></a>使用 MyBatis 注解实现基本 CRUD</h2><h3 id="编写实体类"><a href="#编写实体类" class="headerlink" title="编写实体类"></a>编写实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Date userBirthday;</span><br><span class="line">    <span class="keyword">private</span> String userSex;</span><br><span class="line">    <span class="keyword">private</span> String userAddress;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用注解方式开发持久层接口"><a href="#使用注解方式开发持久层接口" class="headerlink" title="使用注解方式开发持久层接口"></a>使用注解方式开发持久层接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user"</span>)</span><br><span class="line">    <span class="meta">@Results</span>(id = <span class="string">"userMap"</span>,</span><br><span class="line">            value = &#123;</span><br><span class="line">                    <span class="meta">@Result</span>(id = <span class="keyword">true</span>, column = <span class="string">"id"</span>, property = <span class="string">"userId"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"username"</span>, property = <span class="string">"userName"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"sex"</span>, property = <span class="string">"userSex"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"address"</span>, property = <span class="string">"userAddress"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"birthday"</span>, property = <span class="string">"userBirthday"</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"insert into user values(null,#&#123;username&#125;,#&#123;birthday&#125;,#&#123;sex&#125;,#&#123;address&#125;)"</span>)</span><br><span class="line">    <span class="meta">@SelectKey</span>(keyColumn = <span class="string">"id"</span>, keyProperty = <span class="string">"id"</span>, resultType = Integer.class,</span><br><span class="line">            before = <span class="keyword">false</span>, statement = &#123;<span class="string">"select last_insert_id()"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update</span>(<span class="string">"update user set username=#&#123;username&#125;,address=#&#123;address&#125;,sex=#&#123;sex&#125;,birthday=#&#123;birthday&#125; where id=#&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据Id删除用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Delete</span>(<span class="string">"delete from user where id = #&#123;uid&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据Id查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user where id = #&#123;uid&#125;"</span>)</span><br><span class="line">    <span class="meta">@ResultMap</span>(value = &#123;<span class="string">"userMap"</span>&#125;)</span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据名称模糊查询用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user where username like #&#123;username&#125;"</span>)</span><br><span class="line">    <span class="meta">@ResultMap</span>(<span class="string">"userMap"</span>)</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findByName</span><span class="params">(String username)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询总用户数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select count(*) from user"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findTotal</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编写-SqlMapConfig-xml-配置文件"><a href="#编写-SqlMapConfig-xml-配置文件" class="headerlink" title="编写 SqlMapConfig.xml 配置文件"></a>编写 <code>SqlMapConfig.xml</code> 配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入外部配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbcConfig.properties"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置别名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"domain"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 配置环境 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"mysql"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"mysql"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driver&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 指定带有注解的dao接口所在位置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"dao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试方式"><a href="#编写测试方式" class="headerlink" title="编写测试方式"></a>编写测试方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationCRUDTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InputStream config;</span><br><span class="line">    <span class="keyword">private</span> SqlSession session;</span><br><span class="line">    <span class="keyword">private</span> UserDao mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        config = Resources.getResourceAsStream(<span class="string">"SqlMapConfig.xml"</span>);</span><br><span class="line">        session = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(config).openSession();</span><br><span class="line">        mapper = session.getMapper(UserDao.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        session.commit();</span><br><span class="line">        session.close();</span><br><span class="line">        config.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = mapper.findAll();</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUserName(<span class="string">"mybatis annotation"</span>);</span><br><span class="line">        user.setUserSex(<span class="string">"男"</span>);</span><br><span class="line">        user.setUserAddress(<span class="string">"北京市顺义区"</span>);</span><br><span class="line">        user.setUserBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        mapper.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUserId(<span class="number">64</span>);</span><br><span class="line">        user.setUserName(<span class="string">"mybatis annotation"</span>);</span><br><span class="line">        user.setUserAddress(<span class="string">"北京市海淀区"</span>);</span><br><span class="line">        user.setUserSex(<span class="string">"女"</span>);</span><br><span class="line">        user.setUserBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        mapper.updateUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mapper.deleteUser(<span class="number">62</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindOne</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = mapper.findById(<span class="number">41</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindByName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = mapper.findByName(<span class="string">"%王%"</span>);</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = mapper.findTotal();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用注解实现复杂关系映射开发"><a href="#使用注解实现复杂关系映射开发" class="headerlink" title="使用注解实现复杂关系映射开发"></a>使用注解实现复杂关系映射开发</h2><h3 id="复杂关系映射的注解说明"><a href="#复杂关系映射的注解说明" class="headerlink" title="复杂关系映射的注解说明"></a>复杂关系映射的注解说明</h3><ul>
<li><strong><code>@Results</code> 注解</strong>：代替的是标签 <code>&lt;resultMap&gt;</code>。<ul>
<li>该注解中可以使用单个 <code>@Result</code> 注解，也可以使用 <code>@Result</code> 集合。</li>
<li><code>@Results({@Result(), @Result()})</code> 或 <code>@Results(@Result())</code>。</li>
</ul>
</li>
<li><strong><code>@Result</code> 注解</strong>：代替了 <code>&lt;id&gt;</code> 标签和 <code>&lt;result&gt;</code> 标签。<ul>
<li><code>@Result</code> 中属性介绍：<ul>
<li><code>id</code>：是否是主键字段。</li>
<li><code>column</code>：数据库的列名。</li>
<li><code>property</code>：需要装配的属性名。</li>
<li><code>one</code>：需要使用的 <code>@One</code> 注解（<code>@Result(one=@One())</code>）。</li>
<li><code>many</code>：需要使用的 <code>@Many</code> 注解（<code>@Result(many=@Many())</code>）。</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>@One</code> 注解</strong>（一对一）：代替了 <code>&lt;assocation&gt;</code> 标签，是多表查询的关键，在注解中用来指定子查询返回单一对象。<ul>
<li><code>@One</code> 注解属性介绍：<ul>
<li><code>select</code>：指定用来多表查询的 <code>sqlmapper</code>。</li>
<li><code>fetchType</code>：代表会覆盖全局的配置参数 <code>lazyLoadingEnabled</code>。</li>
</ul>
</li>
<li>使用格式：<ul>
<li><code>@Result(column=&quot;&quot;,property=&quot;&quot;,one=@One(select=&quot;&quot;))</code>。</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>@Many</code> 注解</strong>（多对一）：代替了 <code>&lt;Collection&gt;</code> 标签，是多表查询的关键，在注解中用来指定子查询返回对象集合。<ul>
<li>注意：聚集元素用来处理“一对多”的关系。需要指定映射的 Java 实体类的属性，属性的 <code>javaType</code>（一般为 <code>ArrayList</code>）但是注解中可以不定义。</li>
<li>使用格式：<code>@Result(property=&quot;&quot;,column=&quot;&quot;,many=@Many(select=&quot;&quot;))</code>。</li>
</ul>
</li>
</ul>
<h3 id="使用注解实现一对一的复杂关系映射及延迟加载"><a href="#使用注解实现一对一的复杂关系映射及延迟加载" class="headerlink" title="使用注解实现一对一的复杂关系映射及延迟加载"></a>使用注解实现一对一的复杂关系映射及延迟加载</h3><h4 id="添加-User-及-Account-实体类"><a href="#添加-User-及-Account-实体类" class="headerlink" title="添加 User 及 Account 实体类"></a>添加 <code>User</code> 及 <code>Account</code> 实体类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Date userBirthday;</span><br><span class="line">    <span class="keyword">private</span> String userSex;</span><br><span class="line">    <span class="keyword">private</span> String userAddress;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> Double money;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="编写账户的持久层接口"><a href="#编写账户的持久层接口" class="headerlink" title="编写账户的持久层接口"></a>编写账户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有账户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from account"</span>)</span><br><span class="line">    <span class="meta">@Results</span>(id = <span class="string">"accountMap"</span>,</span><br><span class="line">            value = &#123;</span><br><span class="line">                    <span class="meta">@Result</span>(id = <span class="keyword">true</span>, column = <span class="string">"id"</span>, property = <span class="string">"id"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"uid"</span>, property = <span class="string">"uid"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"money"</span>, property = <span class="string">"money"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"uid"</span>, property = <span class="string">"user"</span>,</span><br><span class="line">                            one = <span class="meta">@One</span>(select = <span class="string">"dao.UserDao.findById"</span>, fetchType = FetchType.EAGER))</span><br><span class="line">            &#125;)</span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="编写用户的持久层接口"><a href="#编写用户的持久层接口" class="headerlink" title="编写用户的持久层接口"></a>编写用户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据Id查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user where id = #&#123;uid&#125;"</span>)</span><br><span class="line">    <span class="meta">@Results</span>(id = <span class="string">"userMap"</span>,</span><br><span class="line">            value = &#123;</span><br><span class="line">                    <span class="meta">@Result</span>(id = <span class="keyword">true</span>, column = <span class="string">"id"</span>, property = <span class="string">"userId"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"username"</span>, property = <span class="string">"userName"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"sex"</span>, property = <span class="string">"userSex"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"address"</span>, property = <span class="string">"userAddress"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"birthday"</span>, property = <span class="string">"userBirthday"</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试一对一关联及延迟加载"><a href="#测试一对一关联及延迟加载" class="headerlink" title="测试一对一关联及延迟加载"></a>测试一对一关联及延迟加载</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Account&gt; accounts = mapper.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用注解实现一对多复杂关系映射"><a href="#使用注解实现一对多复杂关系映射" class="headerlink" title="使用注解实现一对多复杂关系映射"></a>使用注解实现一对多复杂关系映射</h3><h4 id="User-实体类加入-List-lt-Account-gt"><a href="#User-实体类加入-List-lt-Account-gt" class="headerlink" title="User 实体类加入 List&lt;Account&gt;"></a><code>User</code> 实体类加入 <code>List&lt;Account&gt;</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Date userBirthday;</span><br><span class="line">    <span class="keyword">private</span> String userSex;</span><br><span class="line">    <span class="keyword">private</span> String userAddress;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Account&gt; accounts;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加用户的持久层接口"><a href="#添加用户的持久层接口" class="headerlink" title="添加用户的持久层接口"></a>添加用户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from user"</span>)</span><br><span class="line">    <span class="meta">@Results</span>(id = <span class="string">"userMap"</span>,</span><br><span class="line">            value = &#123;</span><br><span class="line">                    <span class="meta">@Result</span>(id = <span class="keyword">true</span>, column = <span class="string">"id"</span>, property = <span class="string">"userId"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"username"</span>, property = <span class="string">"userName"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"sex"</span>, property = <span class="string">"userSex"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"address"</span>, property = <span class="string">"userAddress"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"birthday"</span>, property = <span class="string">"userBirthday"</span>),</span><br><span class="line">                    <span class="meta">@Result</span>(column = <span class="string">"id"</span>, property = <span class="string">"accounts"</span>,</span><br><span class="line">                            many = <span class="meta">@Many</span>(select = <span class="string">"dao.AccountDao.findByUid"</span>, fetchType = FetchType.LAZY))</span><br><span class="line">            &#125;)</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加账户的持久层接口"><a href="#添加账户的持久层接口" class="headerlink" title="添加账户的持久层接口"></a>添加账户的持久层接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户Id查询账户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select * from account where uid = #&#123;uid&#125;"</span>)</span><br><span class="line">    <span class="function">List&lt;Account&gt; <span class="title">findByUid</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加测试类"><a href="#添加测试类" class="headerlink" title="添加测试类"></a>添加测试类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = mapper.findAll();</span><br><span class="line">        <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="MyBatis-基于注解的二级缓存"><a href="#MyBatis-基于注解的二级缓存" class="headerlink" title="MyBatis 基于注解的二级缓存"></a>MyBatis 基于注解的二级缓存</h2><h3 id="在-SqlMapConfig-xml-中开启二级缓存支持"><a href="#在-SqlMapConfig-xml-中开启二级缓存支持" class="headerlink" title="在 SqlMapConfig.xml 中开启二级缓存支持"></a>在 <code>SqlMapConfig.xml</code> 中开启二级缓存支持</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 开启二级缓存的支持 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="在持久层接口中使用注解配置二级缓存"><a href="#在持久层接口中使用注解配置二级缓存" class="headerlink" title="在持久层接口中使用注解配置二级缓存"></a>在持久层接口中使用注解配置二级缓存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mybatis基于注解方式实现配置二级缓存</span></span><br><span class="line"><span class="meta">@CacheNamespace</span>(blocking=<span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
      
    

    
    
    

    

    
      
    
    
      <div>
        <div id="reward-container">
  <div>喜欢就支持小方方一下吧~</div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">

    
      
      
        
      
      <div style="display: inline-block">
        <img src="/images/wechatpay.jpg" alt="Flexia 微信支付"/>
        <p>微信支付</p>
      </div>
    
      
      
        
      
      <div style="display: inline-block">
        <img src="/images/alipay.jpg" alt="Flexia 支付宝"/>
        <p>支付宝</p>
      </div>
    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/SSM/" rel="tag"><i class="fa fa-tag"></i> SSM</a>
          
            <a href="/tags/MyBatis/" rel="tag"><i class="fa fa-tag"></i> MyBatis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/07/mybatis-1.html" rel="next" title="MyBatis框架（1）">
                <i class="fa fa-chevron-left"></i> MyBatis框架（1）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/16/spring-1.html" rel="prev" title="Spring框架（1）">
                Spring框架（1） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Flexia"/>
            
              <p class="site-author-name" itemprop="name">Flexia</p>
              <div class="site-description motion-element" itemprop="description">小方方跨到计算机，要开始学习各种计算机知识啦，加油嗷~</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">43</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/fangfengxin" title="GitHub &rarr; https://github.com/fangfengxin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:fangfengxin98@163.com" title="E-Mail &rarr; mailto:fangfengxin98@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-的连接池技术"><span class="nav-number">1.</span> <span class="nav-text">MyBatis 的连接池技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-连接池的分类"><span class="nav-number">1.1.</span> <span class="nav-text">MyBatis 连接池的分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-中-DataSource-的存取"><span class="nav-number">1.2.</span> <span class="nav-text">MyBatis 中 DataSource 的存取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-中连接的获取过程分析"><span class="nav-number">1.3.</span> <span class="nav-text">MyBatis 中连接的获取过程分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-的事务控制"><span class="nav-number">2.</span> <span class="nav-text">MyBatis 的事务控制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-的动态-SQL"><span class="nav-number">3.</span> <span class="nav-text">MyBatis 的动态 SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#动态-SQL-之-lt-if-gt-标签"><span class="nav-number">3.1.</span> <span class="nav-text">动态 SQL 之 &lt;if&gt; 标签</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#持久层-Dao-接口"><span class="nav-number">3.1.1.</span> <span class="nav-text">持久层 Dao 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久层-Dao-映射配置"><span class="nav-number">3.1.2.</span> <span class="nav-text">持久层 Dao 映射配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">3.1.3.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态-SQL-之-lt-where-gt-标签"><span class="nav-number">3.2.</span> <span class="nav-text">动态 SQL 之 &lt;where&gt; 标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态-SQL-之-lt-foreach-gt-标签"><span class="nav-number">3.3.</span> <span class="nav-text">动态 SQL 之 &lt;foreach&gt; 标签</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在-QueryVo-中加入一个-List-集合用于封装参数"><span class="nav-number">3.3.1.</span> <span class="nav-text">在 QueryVo 中加入一个 List 集合用于封装参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久层-Dao"><span class="nav-number">3.3.2.</span> <span class="nav-text">持久层 Dao</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久层-Dao-映射配置-1"><span class="nav-number">3.3.3.</span> <span class="nav-text">持久层 Dao 映射配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-1"><span class="nav-number">3.3.4.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-中简化编写的-SQL-片段"><span class="nav-number">3.4.</span> <span class="nav-text">MyBatis 中简化编写的 SQL 片段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义代码片段"><span class="nav-number">3.4.1.</span> <span class="nav-text">定义代码片段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引用代码片段"><span class="nav-number">3.4.2.</span> <span class="nav-text">引用代码片段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-的多表关联查询"><span class="nav-number">4.</span> <span class="nav-text">MyBatis 的多表关联查询</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-多表查询之一对一（多对一）"><span class="nav-number">4.1.</span> <span class="nav-text">MyBatis 多表查询之一对一（多对一）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方式一：创建输出类型"><span class="nav-number">4.1.1.</span> <span class="nav-text">方式一：创建输出类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义账户信息实体类"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">定义账户信息实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写-SQL-语句"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">编写 SQL 语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义-AccountUser-类"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">定义 AccountUser 类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义账户的持久层-Dao-接口"><span class="nav-number">4.1.1.4.</span> <span class="nav-text">定义账户的持久层 Dao 接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义-AccountUser-xml-映射配置信息"><span class="nav-number">4.1.1.5.</span> <span class="nav-text">定义 AccountUser.xml 映射配置信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建测试类"><span class="nav-number">4.1.1.6.</span> <span class="nav-text">创建测试类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方式二：使用组合"><span class="nav-number">4.1.2.</span> <span class="nav-text">方式二：使用组合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-Account-类"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">修改 Account 类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-AccountDao-接口中的方法"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">修改 AccountDao 接口中的方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重新定义-AccountDao-xml-文件"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">重新定义 AccountDao.xml 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试结果"><span class="nav-number">4.1.2.4.</span> <span class="nav-text">测试结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-多表查询之一对多"><span class="nav-number">4.2.</span> <span class="nav-text">MyBatis 多表查询之一对多</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写-SQL-语句-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">编写 SQL 语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-类中加入-List-lt-Account-gt"><span class="nav-number">4.2.2.</span> <span class="nav-text">User 类中加入 List&lt;Account&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改映射配置文件"><span class="nav-number">4.2.3.</span> <span class="nav-text">修改映射配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试结果-1"><span class="nav-number">4.2.4.</span> <span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-多表查询之多对多"><span class="nav-number">4.3.</span> <span class="nav-text">MyBatis 多表查询之多对多</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#业务要求及-SQL"><span class="nav-number">4.3.1.</span> <span class="nav-text">业务要求及 SQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写角色实体类-Role"><span class="nav-number">4.3.2.</span> <span class="nav-text">编写角色实体类 Role</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写-Role-的持久层接口"><span class="nav-number">4.3.3.</span> <span class="nav-text">编写 Role 的持久层接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写映射配置文件"><span class="nav-number">4.3.4.</span> <span class="nav-text">编写映射配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试结果-2"><span class="nav-number">4.3.5.</span> <span class="nav-text">测试结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-延迟加载策略"><span class="nav-number">5.</span> <span class="nav-text">MyBatis 延迟加载策略</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#何为延迟加载"><span class="nav-number">5.1.</span> <span class="nav-text">何为延迟加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现延迟加载"><span class="nav-number">5.2.</span> <span class="nav-text">实现延迟加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-association-实现延迟加载"><span class="nav-number">5.2.1.</span> <span class="nav-text">使用 association 实现延迟加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#账户的持久层接口"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">账户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#账户的持久层映射配置"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">账户的持久层映射配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户的持久层接口"><span class="nav-number">5.2.1.3.</span> <span class="nav-text">用户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户的持久层映射配置"><span class="nav-number">5.2.1.4.</span> <span class="nav-text">用户的持久层映射配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开启-MyBatis-的延迟加载"><span class="nav-number">5.2.1.5.</span> <span class="nav-text">开启 MyBatis 的延迟加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写测试只查询账户信息不查用户信息"><span class="nav-number">5.2.1.6.</span> <span class="nav-text">编写测试只查询账户信息不查用户信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-collection-实现延迟加载"><span class="nav-number">5.2.2.</span> <span class="nav-text">使用 collection 实现延迟加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#用户的持久层接口-1"><span class="nav-number">5.2.2.1.</span> <span class="nav-text">用户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户的持久层映射配置-1"><span class="nav-number">5.2.2.2.</span> <span class="nav-text">用户的持久层映射配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#账户的持久层接口-1"><span class="nav-number">5.2.2.3.</span> <span class="nav-text">账户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#账户的持久层映射配置-1"><span class="nav-number">5.2.2.4.</span> <span class="nav-text">账户的持久层映射配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试只加载用户信息"><span class="nav-number">5.2.2.5.</span> <span class="nav-text">测试只加载用户信息</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-缓存"><span class="nav-number">6.</span> <span class="nav-text">MyBatis 缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简单认识缓存"><span class="nav-number">6.1.</span> <span class="nav-text">简单认识缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-中的一级缓存"><span class="nav-number">6.2.</span> <span class="nav-text">MyBatis 中的一级缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#证明一级缓存的存在"><span class="nav-number">6.2.1.</span> <span class="nav-text">证明一级缓存的存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#触发一级缓存的清空"><span class="nav-number">6.2.2.</span> <span class="nav-text">触发一级缓存的清空</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-的二级缓存"><span class="nav-number">6.3.</span> <span class="nav-text">MyBatis 的二级缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#二级缓存结构图"><span class="nav-number">6.3.1.</span> <span class="nav-text">二级缓存结构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二级缓存的开启"><span class="nav-number">6.3.2.</span> <span class="nav-text">二级缓存的开启</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在-SQLMapConfig-xml-文件中开启二级缓存"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">在 SQLMapConfig.xml 文件中开启二级缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置相关的-Mapper-映射文件"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">配置相关的 Mapper 映射文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-statement-上的-useCache-属性"><span class="nav-number">6.3.2.3.</span> <span class="nav-text">配置 statement 上的 useCache 属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二级缓存测试"><span class="nav-number">6.3.2.4.</span> <span class="nav-text">二级缓存测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二级缓存注意事项"><span class="nav-number">6.3.3.</span> <span class="nav-text">二级缓存注意事项</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyBatis-注解开发"><span class="nav-number">7.</span> <span class="nav-text">MyBatis 注解开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-的常见注解说明"><span class="nav-number">7.1.</span> <span class="nav-text">MyBatis 的常见注解说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-MyBatis-注解实现基本-CRUD"><span class="nav-number">7.2.</span> <span class="nav-text">使用 MyBatis 注解实现基本 CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写实体类"><span class="nav-number">7.2.1.</span> <span class="nav-text">编写实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用注解方式开发持久层接口"><span class="nav-number">7.2.2.</span> <span class="nav-text">使用注解方式开发持久层接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写-SqlMapConfig-xml-配置文件"><span class="nav-number">7.2.3.</span> <span class="nav-text">编写 SqlMapConfig.xml 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写测试方式"><span class="nav-number">7.2.4.</span> <span class="nav-text">编写测试方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用注解实现复杂关系映射开发"><span class="nav-number">7.3.</span> <span class="nav-text">使用注解实现复杂关系映射开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#复杂关系映射的注解说明"><span class="nav-number">7.3.1.</span> <span class="nav-text">复杂关系映射的注解说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用注解实现一对一的复杂关系映射及延迟加载"><span class="nav-number">7.3.2.</span> <span class="nav-text">使用注解实现一对一的复杂关系映射及延迟加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加-User-及-Account-实体类"><span class="nav-number">7.3.2.1.</span> <span class="nav-text">添加 User 及 Account 实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写账户的持久层接口"><span class="nav-number">7.3.2.2.</span> <span class="nav-text">编写账户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写用户的持久层接口"><span class="nav-number">7.3.2.3.</span> <span class="nav-text">编写用户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试一对一关联及延迟加载"><span class="nav-number">7.3.2.4.</span> <span class="nav-text">测试一对一关联及延迟加载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用注解实现一对多复杂关系映射"><span class="nav-number">7.3.3.</span> <span class="nav-text">使用注解实现一对多复杂关系映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#User-实体类加入-List-lt-Account-gt"><span class="nav-number">7.3.3.1.</span> <span class="nav-text">User 实体类加入 List&lt;Account&gt;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加用户的持久层接口"><span class="nav-number">7.3.3.2.</span> <span class="nav-text">添加用户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加账户的持久层接口"><span class="nav-number">7.3.3.3.</span> <span class="nav-text">添加账户的持久层接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加测试类"><span class="nav-number">7.3.3.4.</span> <span class="nav-text">添加测试类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MyBatis-基于注解的二级缓存"><span class="nav-number">7.4.</span> <span class="nav-text">MyBatis 基于注解的二级缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在-SqlMapConfig-xml-中开启二级缓存支持"><span class="nav-number">7.4.1.</span> <span class="nav-text">在 SqlMapConfig.xml 中开启二级缓存支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在持久层接口中使用注解配置二级缓存"><span class="nav-number">7.4.2.</span> <span class="nav-text">在持久层接口中使用注解配置二级缓存</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-snowflake-o"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Flexia</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">743k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">11:15</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  





  
    
    
  
  <script color='0,0,0' opacity='1' zIndex='-1' count='20' src="/lib/canvas-nest/canvas-nest.min.js"></script>









  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  
  

<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '7kWTdJsaz4FTWvD11vJ68LrU-gzGzoHsz',
    appKey: 'IagQj5azVtsiUPyjWRrvasm6',
    placeholder: '要不要说点啥……',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn'
  });
</script>




  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  
<script>
if ($('body').find('pre.mermaid').length) {
  $.ajax({
    type: 'GET',
    url: '//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js',
    dataType: 'script',
    cache: true,
    success: function() {
      mermaid.initialize({
        theme: 'forest',
        logLevel: 3,
        flowchart: { curve: 'linear' },
        gantt: { axisFormat: '%m/%d/%Y' },
        sequence: { actorMargin: 50 }
      });
    }
  });
}
</script>


  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  


  

</body>
</html>
